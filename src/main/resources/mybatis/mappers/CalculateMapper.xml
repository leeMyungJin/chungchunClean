<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.chungchunClean.Mappers.CalculateMapper">

<select id="getMonList" parameterType="hashMap" resultType="CalculateVo">
	select bb.area_cd
		, bb.area_nm
		, bb.bldg_cd
		, bb.bldg_nm
		, bb.surtax 
		, bb.surtax_yn 
		, amm.manage_cost 
		, amm.tax_bill
		, amm.add_cost 
		, amm.out_cost 
		, amm.over_cost 
		, amm.deposit_cost 
		, to_char(amm.deposit_dt , 'YYYY-MM-DD') as deposit_dt 
		, amm.depositor 
		, amm.pnum 
		, amm.memo
	from web.adjust_mt_manage amm left join web.bldg_bas bb on amm.bldg_cd = bb.bldg_cd
	where
		1 = 1
	<if test="inq != null">
		<choose>
			<when test="con == 'all'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					bb.area_nm LIKE '%' || #{item} || '%'
					or
					bb.bldg_nm LIKE '%' || #{item} || '%'
					or
					amm.depositor LIKE '%' || #{item} || '%'
				</foreach>
			</when>
			<when test="con == 'site'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					bb.area_nm LIKE '%' || #{item} || '%'
				</foreach>
			</when>
			<when test="con == 'building'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					bb.bldg_nm LIKE '%' || #{item} || '%'
				</foreach>
			</when>
			<when test="con == 'depositor'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					amm.depositor LIKE '%' || #{item} || '%'
				</foreach>
			</when>
		</choose>
	</if>
	<if test="fromDate != null and toDate != null">
		and amm.cret_dt between #{fromDate}::timestamp and (to_date(#{toDate}, 'YYYY-MM-DD')+1)::timestamp
	</if>
	ORDER BY bb.area_cd, bb.area_nm, amm.deposit_dt
</select>


<select id="getMonTodayCost" resultType="HashMap">
	select coalesce(sum(amm.out_cost), 0) as outCost -- 금년 미수금
       	,coalesce(sum(amm.deposit_cost), 0) as depositCost -- 금년 입금금액 (부가세포함)
      	,coalesce(sum(amm.add_cost), 0) as addCost --금년 추가금
	from web.adjust_mt_manage amm left join web.bldg_bas bb on amm.bldg_cd = bb.bldg_cd
	where 1=1
	and extract('YEAR' from deposit_dt) = extract('YEAR' from now())
</select>

<select id="getMonlableCost" parameterType="hashMap" resultType="HashMap">
select coalesce(sum(amm.out_cost), 0) as outCost -- 금년 미수금
      ,coalesce(sum(amm.deposit_cost), 0) as depositCost -- 금년 입금금액 (부가세포함)
      ,coalesce(sum(amm.add_cost), 0) as addCost --금년 추가금
	from web.adjust_mt_manage amm left join web.bldg_bas bb on amm.bldg_cd = bb.bldg_cd
	where 1=1
		<if test="inq != null">
		<choose>
			<when test="con == 'all'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					bb.area_nm LIKE '%' || #{item} || '%'
					or
					bb.bldg_nm LIKE '%' || #{item} || '%'
					or
					amm.depositor LIKE '%' || #{item} || '%'
				</foreach>
			</when>
			<when test="con == 'site'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					bb.area_nm LIKE '%' || #{item} || '%'
				</foreach>
			</when>
			<when test="con == 'building'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					bb.bldg_nm LIKE '%' || #{item} || '%'
				</foreach>
			</when>
			<when test="con == 'depositor'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					amm.depositor LIKE '%' || #{item} || '%'
				</foreach>
			</when>
		</choose>
	</if>
	<if test="fromDate != null and toDate != null">
		and amm.cret_dt between #{fromDate}::timestamp and (to_date(#{toDate}, 'YYYY-MM-DD')+1)::timestamp
	</if>
</select>


<select id="getAddList" parameterType="hashMap" resultType="CalculateVo">
	select to_char(aa.add_dt , 'YYYY-MM-DD') as add_dt 
			, aa.classifi_cd 
			, aacb.classifi_nm 
			, aa.item_cd
			, aacd.item_nm 
			, bb.bldg_cd 
			, bb.bldg_nm 
			, aa.quote_cost 
			, aa.mater_cost 
			, aa.outsc_cost 
			, aa.deposit_cost 
			, to_char(aa.deposit_dt , 'YYYY-MM-DD') as deposit_dt 
			, aa.depositor 
			, aa.cret_dt 
			, aa.cret_id 
			, aa.updt_dt 
			, aa.updt_id 
	from web.adjust_add aa left join web.bldg_bas bb on aa.bldg_cd = bb.bldg_cd 
							left join web.adjust_add_cd_bas aacb on aa.classifi_cd = aacb.classifi_cd 
							left join web.adjust_add_cd_dtl aacd on aacb.classifi_cd = aacd.classifi_cd and aacd.item_cd = aa.item_cd 
	where
		1 = 1
	<if test="inq != null">
		<choose>
			<when test="con == 'all'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					bb.area_nm LIKE '%' || #{item} || '%'
					or
					bb.bldg_nm LIKE '%' || #{item} || '%'
					or
					aa.depositor LIKE '%' || #{item} || '%'
				</foreach>
			</when>
			<when test="con == 'site'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					bb.area_nm LIKE '%' || #{item} || '%'
				</foreach>
			</when>
			<when test="con == 'building'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					bb.bldg_nm LIKE '%' || #{item} || '%'
				</foreach>
			</when>
			<when test="con == 'depositor'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					aa.depositor LIKE '%' || #{item} || '%'
				</foreach>
			</when>
		</choose>
	</if>
	<if test="date != null">
		and to_char(aa.cret_dt, 'YYYY-MM') = #{date}
	</if>
	ORDER BY bb.area_cd, bb.area_nm, aa.deposit_dt
</select>



<select id="getAddTodayCost" resultType="HashMap">
select coalesce(sum(aa.quote_cost), 0) as quoteCost --금년 견적
		, coalesce(sum(aa.add_cost), 0) as addCost --금년 추가금
		, coalesce(sum(aa.out_cost), 0) as overCost --금년 이월금
		, coalesce(sum(aa.deposit_cost), 0) as depositCost --금년 입금금액
from web.adjust_add aa left join web.bldg_bas bb on aa.bldg_cd = bb.bldg_cd 
where extract('YEAR' from aa.deposit_dt) = extract('YEAR' from now())	
</select>

<select id="getAddlableCost" parameterType="hashMap" resultType="HashMap">
select coalesce(sum(aa.mater_cost), 0) as materCost --재료비
		, coalesce(sum(aa.outsc_cost), 0) as outscCost --외주비
		, coalesce(sum(aa.deposit_cost), 0) as depositCost  --입금
		, coalesce(sum(aa.quote_cost), 0) as quoteCost -- 견적금
		, coalesce(sum(aa.add_cost), 0) as addCost --추가금
		, coalesce(sum(aa.over_cost), 0) as overCost  --이월금
from web.adjust_add aa left join web.bldg_bas bb on aa.bldg_cd = bb.bldg_cd 
	where 1=1
	<if test="inq != null">
		<choose>
			<when test="con == 'all'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					bb.area_nm LIKE '%' || #{item} || '%'
					or
					bb.bldg_nm LIKE '%' || #{item} || '%'
					or
					aa.depositor LIKE '%' || #{item} || '%'
				</foreach>
			</when>
			<when test="con == 'site'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					bb.area_nm LIKE '%' || #{item} || '%'
				</foreach>
			</when>
			<when test="con == 'building'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					bb.bldg_nm LIKE '%' || #{item} || '%'
				</foreach>
			</when>
			<when test="con == 'depositor'">
			AND 
				<foreach collection="inq" item="item"
					index="index" open="(" close=")" separator="or">
					aa.depositor LIKE '%' || #{item} || '%'
				</foreach>
			</when>
		</choose>
	</if>
	<if test="date != null">
		and to_char(aa.cret_dt, 'YYYY-MM') = #{date}
	</if>
</select>

	
</mapper>